import streamlit as st
import pandas as pd

st.set_page_config(page_title="å­¸åˆ†è¨ˆç®—å™¨", page_icon="ğŸ“", layout="centered")
st.title("ğŸ“ å­¸åˆ†è¨ˆç®—å™¨ï¼ˆæ–°æ‰‹ç‰ˆ MVPï¼‰")

st.write("å…ˆè¼¸å…¥éœ€æ±‚ï¼Œå†è¼¸å…¥å·²ä¿®/é è¨ˆä¿®èª²ç¨‹ï¼Œç³»çµ±æœƒè‡ªå‹•ç®—å‡ºé‚„ç¼ºå¤šå°‘å­¸åˆ†ã€‚")

# -------------------------
# 1) è¼¸å…¥å­¸åˆ†éœ€æ±‚
# -------------------------
st.header("1) è¼¸å…¥å­¸åˆ†éœ€æ±‚")

default_req = pd.DataFrame(
    [
        {"é¡åˆ¥": "ç•¢æ¥­ç¸½å­¸åˆ†", "éœ€æ±‚å­¸åˆ†": 128},
        {"é¡åˆ¥": "å¿…ä¿®", "éœ€æ±‚å­¸åˆ†": 60},
        {"é¡åˆ¥": "ç³»é¸ä¿®", "éœ€æ±‚å­¸åˆ†": 40},
        {"é¡åˆ¥": "é€šè­˜", "éœ€æ±‚å­¸åˆ†": 28},
    ]
)

req_df = st.data_editor(
    default_req,
    num_rows="dynamic",
    use_container_width=True
)

# éœ€æ±‚å­—å…¸ï¼š{é¡åˆ¥: éœ€æ±‚å­¸åˆ†}
requirements = {row["é¡åˆ¥"]: int(row["éœ€æ±‚å­¸åˆ†"]) for _, row in req_df.iterrows()}

# -------------------------
# 2) è¼¸å…¥ä¿®èª²è³‡æ–™
# -------------------------
st.header("2) è¼¸å…¥å·²ä¿® / é è¨ˆä¿®èª²ç¨‹")

st.caption("é¡åˆ¥è¦è·Ÿä¸Šé¢éœ€æ±‚çš„é¡åˆ¥åç¨±ä¸€è‡´ï¼Œä¾‹å¦‚ï¼šå¿…ä¿® / ç³»é¸ä¿® / é€šè­˜ã€‚")

default_courses = pd.DataFrame(
    [
        {"èª²å": "å¾®ç©åˆ†(ä¸€)", "é¡åˆ¥": "å¿…ä¿®", "å­¸åˆ†": 3, "ç‹€æ…‹": "å·²ä¿®"},
        {"èª²å": "ç¨‹å¼è¨­è¨ˆ", "é¡åˆ¥": "å¿…ä¿®", "å­¸åˆ†": 3, "ç‹€æ…‹": "å·²ä¿®"},
        {"èª²å": "çµ±è¨ˆå­¸", "é¡åˆ¥": "å¿…ä¿®", "å­¸åˆ†": 3, "ç‹€æ…‹": "é è¨ˆ"},
        {"èª²å": "é€šè­˜ï¼šå¿ƒç†å­¸å…¥é–€", "é¡åˆ¥": "é€šè­˜", "å­¸åˆ†": 2, "ç‹€æ…‹": "å·²ä¿®"},
        {"èª²å": "ç³»é¸ä¿®ï¼šè³‡æ–™åˆ†æ", "é¡åˆ¥": "ç³»é¸ä¿®", "å­¸åˆ†": 3, "ç‹€æ…‹": "é è¨ˆ"},
    ]
)

courses_df = st.data_editor(
    default_courses,
    num_rows="dynamic",
    use_container_width=True
)

# é˜²å‘†ï¼šç©ºè¡¨æ™‚é¿å…éŒ¯èª¤
if len(courses_df) == 0:
    st.warning("è«‹è‡³å°‘è¼¸å…¥ä¸€ç­†èª²ç¨‹è³‡æ–™ã€‚")
    st.stop()

# -------------------------
# 3) è¨ˆç®—ç¼ºå£
# -------------------------
st.header("3) è¨ˆç®—çµæœ")

# è¨ˆç®—ï¼šä¾é¡åˆ¥åŠ ç¸½å·²ä¿®/é è¨ˆå­¸åˆ†
def sum_credits(status: str):
    tmp = courses_df[courses_df["ç‹€æ…‹"] == status]
    return tmp.groupby("é¡åˆ¥")["å­¸åˆ†"].sum().to_dict()

completed = sum_credits("å·²ä¿®")
planned = sum_credits("é è¨ˆ")

# çµ„å‡ºçµæœè¡¨
rows = []
for cat, need in requirements.items():
    got = int(completed.get(cat, 0))
    plan = int(planned.get(cat, 0))
    remain = max(need - (got + plan), 0)
    rows.append({
        "é¡åˆ¥": cat,
        "éœ€æ±‚": need,
        "å·²ä¿®": got,
        "é è¨ˆ": plan,
        "é‚„ç¼º": remain
    })

result_df = pd.DataFrame(rows)

st.dataframe(result_df, use_container_width=True)

# -------------------------
# 4) ç°¡å–®æ¨è–¦ï¼ˆç”¨ä½ è¼¸å…¥çš„èª²ç¨‹ç•¶å€™é¸ï¼‰
# -------------------------
st.header("4) æ¨è–¦å¯ä»¥è£œç¼ºå£çš„èª²ï¼ˆç°¡å–®ç‰ˆï¼‰")

gap_cats = result_df[result_df["é‚„ç¼º"] > 0]["é¡åˆ¥"].tolist()

if len(gap_cats) == 0:
    st.success("æ­å–œï¼ä¾ç…§ä½ ç›®å‰çš„å·²ä¿® + é è¨ˆï¼Œçœ‹èµ·ä¾†éƒ½æ»¿è¶³éœ€æ±‚äº† ğŸ‰")
else:
    st.write("ä½ ç›®å‰ç¼ºå£çš„é¡åˆ¥ï¼š", "ã€".join(gap_cats))

    # æ¨è–¦è¦å‰‡ï¼šç¼ºä»€éº¼é¡åˆ¥ï¼Œå°±æŠŠè©²é¡åˆ¥çš„ã€Œé è¨ˆã€èª²ç¨‹åˆ—å‡ºä¾†ï¼ˆä½ ä¹Ÿå¯ä»¥æŠŠå€™é¸ç•¶ä½œå­¸æ ¡èª²ç¨‹åº«çš„é››å½¢ï¼‰
    rec_df = courses_df[courses_df["é¡åˆ¥"].isin(gap_cats)].copy()
    rec_df = rec_df.sort_values(by=["é¡åˆ¥", "ç‹€æ…‹"], ascending=[True, True])

    st.dataframe(rec_df, use_container_width=True)

st.caption("ä¸‹ä¸€æ­¥å‡ç´šï¼šæŠŠã€èª²ç¨‹å€™é¸æ¸…å–®ã€æ”¹æˆå¾å­¸æ ¡èª²ç¨‹ç¶²ç«™åŒæ­¥æˆ– CSV åŒ¯å…¥ï¼Œå°±èƒ½çœŸçš„æ¨è–¦å­¸æ ¡çš„èª²ã€‚")